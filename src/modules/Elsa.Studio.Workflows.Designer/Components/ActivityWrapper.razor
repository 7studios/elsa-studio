@using Elsa.Api.Client.Resources.ActivityDescriptors.Enums
@using Humanizer
@using Elsa.Api.Client.Activities
@using Elsa.Api.Client.Extensions
@using System.Text.Json
@using Elsa.Api.Client.Converters
@{
    const string white = "#ffffff";
    var colorStyle = CanStartWorkflow ? $"color: {white};" : "";
}
<MudPaper
    Class="elsa-activity pa-3"
    Style="@($"border-left-color: {_color}; {(CanStartWorkflow ? $"background-color: {_color}" : "")};")"
    Outlined="true">
    <MudStack Row="true" AlignItems="AlignItems.Center" Style="height:100%">
        @if (_icon != null)
        {
            <MudIcon Icon="@_icon" Style="@colorStyle"></MudIcon>
        }
        <MudStack Style="height:100%" Justify="Justify.Center">
            <MudText Typo="Typo.body1" Style="@colorStyle">@_label</MudText>

            @if (_activityDescriptor.Ports.Any(x => x.Type == PortType.Embedded))
            {
                <MudStack Row="true">
                    @foreach (var port in _activityDescriptor.Ports.Where(x => x.Type == PortType.Embedded))
                    {
                        var propName = port.Name.Camelize();
                        var options = new JsonSerializerOptions
                        {
                            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                        };

                        options.Converters.Add(new ActivityJsonConverterFactory(ServiceProvider));
                        options.Converters.Add(new ExpressionJsonConverterFactory());

                        var childActivity = Activity.TryGetValue(propName, out var value) ? value.ConvertTo<Activity>(new ObjectConverterOptions(options)) : null;

                        @if (childActivity != null)
                        {
                            <MudField Label="@port.DisplayName" Variant="Variant.Outlined">
                                <div id="@($"activity-{childActivity.Id}")" class="embedded-port-occupied" data-port-name="@port.Name" @onclick="@(async () => await OnEmbeddedActivityClicked(childActivity))" draggable="true" @ondragstart="@(() => OnChildActivityDragStart())">
                                    <EmbeddedActivityWrapper ActivityId="@childActivity.Id" Activity="childActivity" IsSelected="@(SelectedPortName == port.Name)"/>
                                </div>
                            </MudField>
                        }
                        else
                        {
                            <a @onclick="@(() => OnEmptyPortClicked(port))" @onclick:preventDefault>
                                <MudPaper Elevation="0" Class="embedded-port pa-4" data-port-name="@port.Name" Style="border: 1px dashed var(--mud-palette-lines-default)">
                                    @port.DisplayName
                                </MudPaper>
                            </a>
                        }
                    }
                </MudStack>
            }

            @if (!string.IsNullOrWhiteSpace(_description) && _showDescription)
            {
                <MudText Typo="Typo.caption" Style="@colorStyle">@_description</MudText>
            }
        </MudStack>
    </MudStack>

</MudPaper>