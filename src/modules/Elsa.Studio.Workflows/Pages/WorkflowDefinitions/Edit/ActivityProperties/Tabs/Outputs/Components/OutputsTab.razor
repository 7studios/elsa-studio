@using Variant = MudBlazor.Variant
@using Elsa.Api.Client.Extensions
@using Elsa.Api.Client.Models
@using Elsa.Studio.Workflows.Pages.WorkflowDefinitions.Edit.ActivityProperties.Tabs.Outputs.Models

<div class="pa-4">
    <MudForm>
        <MudStack Spacing="6">
            @foreach (var outputDescriptor in OutputDescriptors)
            {
                var activity = Activity;
                var displayName = string.IsNullOrWhiteSpace(outputDescriptor.DisplayName) ? outputDescriptor.Name : outputDescriptor.DisplayName;
                var propertyName = outputDescriptor.Name.Camelize();
                var propertyValue = activity.TryGetValue<ActivityOutput>(propertyName);
                var propertyType = _variableTypes.TryGetValue(outputDescriptor.TypeName, out var type) ? type : default;
                var propertyTypeName = propertyType?.DisplayName ?? outputDescriptor.TypeName;
                var selectedValue = _bindingTargetOptions.FirstOrDefault(x => x.Value == propertyValue?.MemoryReference?.Id);
                
                <MudSelectExtended 
                    T="BindingTargetOption" 
                    Label="@displayName" 
                    Variant="Variant.Outlined" 
                    HelperText="@outputDescriptor.Description" 
                    Value="@selectedValue" 
                    Dense="false" 
                    Margin="Margin.Normal"
                    AdornmentText="@propertyTypeName"
                    Adornment="Adornment.End"
                    ToStringFunc="@(x => x?.Text)"
                    ValueChanged="@(bindingOption => OnBindingChanged(bindingOption, outputDescriptor))">
                    @foreach(var bindingTargetGroup in _bindingTargetGroups)
                    {
                        <MudSelectItemGroupExtended T="string" Text="@bindingTargetGroup.Text">
                            @foreach(var bindingTargetOption in bindingTargetGroup.Options)
                            {
                                <MudSelectItemExtended T="BindingTargetOption" Value="@bindingTargetOption">@bindingTargetOption.Text</MudSelectItemExtended>
                            }
                        </MudSelectItemGroupExtended>
                    }
                </MudSelectExtended>
            }
        </MudStack>
    </MudForm>
</div>